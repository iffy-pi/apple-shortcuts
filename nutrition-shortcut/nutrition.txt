def WeekSummary():

def NutriDixUpdater():

def FoodHistory():

def BarcodeSearch():

def GetBarcode():

def RemovePreset():

def EditPreset(): # Edit Preset

def GetPreset(): # Get Preset

def DisplayFoodItem():

def SearchAlgorithm():


def BulkEntry(): # Bulk Entry

def MakePreset(): # Make Preset

def FoodsList(): # Foods List

def LogAlgorithm(): # Log Algorithm

def GetRecent(): # "Get Recent"


def NutriDix():
	return ;;


# GLOBAL VARS
STORAGE_PATH = "Shortcuts/FLS"

def Nutrition():
	zero = 0
	quick = 0
	backprompt = 0

	one = 1
	result = run("NutriDix")
	NutriDic = Dictionary(result)

	DVal = NutriDic['Total Energy Today']

	deviceModel = GetDeviceDetails("Model")
	if deviceModel != 'iPhone':
		text = f"Foods logged on {deviceModel} will be added to backlog"

	else:
		healthSamples = HealthApp.Find(
				AllHealthSamples,
				whereAllAreTrue=[
					Type="Dietary Energy",
					StartDate=Today,
				],
				Unit=cal
			)

		unit = Health.Sample.GetDetails(healthSamples[0], "Unit")

		REPEATRESULTS = []
		for sample in healthSamples:
			# this is done in shortcuts by just getting the value at the end of repeat
			# it automatically aggregates repeat results
			REPEATRESULTS.append(Health.Sample.GetDetails(sample, "Value"))


		Ks = Round( Sum(REPEATRESULTS), "hundredths")

		if Count("Items", Ks) < 1:
			Ks = 0

		file = GetFile("Shortcuts/FLS/Other/backtag.txt")

		if file is not None:
			toClear = str(file.read())

		else
			toClear = 0

		IFRESULT = f"You've eaten {Ks} Calories Today."

	Prompt = IFRESULT

	mainMenu = Menu(prompt=prompt, options=[
			"Quick Log",
			"Log Foods",
			"Log Foods In Bulk",
			"Search and View",
			"Presets",
			"Barcodes",
			"Recent Meals",
			"Weekly Summary",
			"Food History",
			"Clear Backlog",
		])

	if mainMenu.opt("Quick Log"):
		# InRecents does not exist!
		for item in run("Get Recent", input=InRecents):
			CurFood = item
			text = f"How many servings of {CurFood['Name']}\n(1 serving = {CurFood['Serving Size']})"
			
			# translates to set dictionary value in CurFood and then set dictionary
			CurFood['Servings'] = AskForInput(text, Input.Number, default=1, allowDecimalNumbers=True, allowNegativeNumbers=True)

			LogList.Append(f"{Date.CurrentDate}\n{CurFood}")

		for item in LogList:
			run("Log Algorithm", input=item)

		if toClear == 1:
			quick = toClear
		else
			return

	elif mainMenu.opt("Log Foods"):
		if GetDeviceDetails("Model") == 'iPhone':
			# action will be discontinued in later versions
			ContinueInShortcutsApp()

		LoggedFoodsDix = {
			'SAMPLE' : 'SAMPLE'
		}

		Dating = AskForInput("What date and time? Click Done for Right Now", Input.DateAndTime)


		for item in run("Foods List"):
			CurFood = item
			text = f"{Dating}\n{CurFood}"
			CurLoggedFood = run("Log Algorithm", input=text)
			
			# Comment: Get the logged food dictionary and add it into the logged foods dix,
			# with key: servings of food and value: food dictionary

			roundedNumber = Round(Number(CurLoggedFood['Servings']), "Hundredths")
			LoggedFoodsDix[ f"{roundedNumber}x{CurLoggedFood['name']}" ] = CurLoggedFood


		makePresetMenu = Menu(prompt="Make Preset?", options=["Yes", "No"])

		if makePresetMenu.opt("Yes"):
			# Get the keys from the logged foods dix so users can select what foods they want to make into a preset
			res = Filter( 
				SplitText(Text(LoggedFoodsDix.Keys)), 
				where=[
					"Name" is not "SAMPLE",
				])

			chosenItems = ChooseFrom(res, prompt="Select Foods For Preset", selectMultiple=True)

			for item in chosenItems:
				# With each chosen key we use the key to retrieve the value from logged food dix
				# and add it to the list of foods to be made into a preset (chosenFoods)
				# each item in this case are the keys from the loggedfoodsdix
				ChosenFoods.Append( LoggedFoodsDix[item] )

			# run make preset with chosen foods
			run("Make Preset", input=ChosenFoods)

		elif makePresetMenu.opt("No"):
			pass

	elif mainMenu.opt("Log Foods In Bulk"):
		if GetDeviceDetails("Model") == 'iPhone':
			# action will be discontinued in later versions
			ContinueInShortcutsApp()

		run("Bulk Entry")

	elif mainMenu.opt("Search and View"):
		# run search algorithm and display food with 

		searchResult = run("Display Food Item", input=run("Search Algorithm"))

		postSearchMenu = Menu(["Log Entry", "Make Preset", "Exit"])

		if postSearchMenu.opt("Log Entry"):
			date = AskForInput("Date:", Input.DateAndTime, default=Date.CurrentDate)
			text = f"{date}\n{searchResult}"
			res = run(
				"Log Algorithm",
				input=text)

			LoggedFoods2 = res

			svp = Menu(["Yes", "No"], prompt="Save As Preset?")

			if svp.opt("Yes"):
				RunShorctut("Make Preset", input=LoggedFoods2)
			if svp.opt("No"):
				pass

		elif postSearchMenu.opt("Make Preset"):
			run("Make Preset", input=searchResult)

		elif postSearchMenu.opt("Exit"):
			pass

	elif mainMenu.opt("Presets"):

		prm = Menu(prompt="Presets", options=["View Presets", "Make Preset", "Edit Preset", "Remove Preset(s)"])

		if prm.opt("View Presets"):
			res = run("Get Preset")
			for repeatItem in res:
				run("Display Food Item", input=repeatItem)

		elif prm.opt("Make Preset"):
			# run foods list to get list of foods to be made into a preset
			res = run("Foods List")

			for item in res:
				curFood = item
				loggedFoods3.append(curFood)

			run("Make Preset", loggedFoods3)


		elif prm.opt("Edit Preset"):
			run("Edit Preset")


		elif prm.opt("Remove Preset(s)"):
			# retrieve preset names, let user choose preset then retrieve food dix and delete it by running remove preset
			file = GetFile(f"{STORAGE_PATH}/Presets/presetNames.txt")
			res = SplitText(file, SplitText.ByNewLines)
			
			presetsToBeDeleted = ChooseFrom(res, selectMultiple=True)

			ShowAlert("Do You Want To Continue?", title="Presets About to Be Deleted", showCancel=True)

			for item in presetsToBeDeleted:
				file = GetFile(f"{STORAGE_PATH}/Presets/Foods/{item}.txt")
				text = file.read()
				run("Remove Preset", text)

	elif mainMenu.opt("Barcodes"):
		brm = Menu(prompt="Barcodes", options=[
			"View Personal Database",
			"Add to Personal Database",
			"Edit Items in Personal Database",
			"Remove From Personal Database"
			])


		if brm.opt("View Personal Database"):
			res = run("Get Barcode")
			for item in res:
				run("Display Food Item", input=item)

		elif brm.opt("Add to Personal Database"):
			run("Barcode Search")

		elif brm.opt("Edit Items in Personal Database"):
			run("Edit Barcode")

		elif brm.opt("Remove From Personal Database"):
			res = run("Get Barcode")
			run("Remove Barcode", input=res)
		

	elif mainMenu.opt("Recent Meals"):
		res = run("Get Recent")
		for item in res:
			run("Display Food Item", input=item)


	elif mainMenu.opt("Weekly Summary"):
		run("Week Summary")


	elif mainMenu.opt("Food History"):
		file = GetFile(f"{STORAGE_PATH}/Other/backtag.txt")
		if file is not None:
			res = run("Get Barcode")
			for item in res:
				run("Display Food Item", input=item)

		run("Food History")

	elif mainMenu.opt("Clear Backlog"):
		backprompt = one


	# clearing the backlog
	if GetDeviceDetails("Device Model") == "iPhone":
		if toClear == 1:
			ShowNotification("Logging foods in backlog...", title="Backlog Detected")

			file = GetFile(f"{STORAGE_PATH}/Other/backlog.txt")
			res = SplitText(file, ByNewLines)

			for item in res:
				text = f"{item['Date']}\n{item['Food']}"
				run("Log Algorithm", input=text)

			text = 0
			SaveFile(text, path=f"{STORAGE_PATH}/Other/backlog.txt")
			SaveFile(text, path=f"{STORAGE_PATH}/Other/backtag.txt")

		else:
			if backprompt == 1:
				ShowAlert("Nothing to clear")

	if quick == 0:
		run("NutriDix Updater")




